var F=Object.create;var A=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var _=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var $=e=>A(e,"__esModule",{value:!0});var H=(e,t)=>{$(e);for(var n in t)A(e,n,{get:t[n],enumerable:!0})},K=(e,t,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of N(t))!B.call(e,r)&&r!=="default"&&A(e,r,{get:()=>t[r],enumerable:!(n=j(t,r))||n.enumerable});return e},L=e=>K($(A(e!=null?F(_(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);H(exports,{CANVAS_CONTENTFUL_PARAMETER_TYPES:()=>S,ContentfulClientList:()=>P,contentfulRichTextToHtmlEnhancer:()=>G,createContentfulEnhancer:()=>D});var h=L(require("@uniformdev/canvas"));var P=class{constructor(t){this._clients={},Array.isArray(t)?t.forEach(n=>this.addClient(n)):t&&this.addClient(t)}addClient({source:t="default",client:n,previewClient:r}){if(this._clients[t])throw new Error(`The source ${t} is always registered`);if(!n)throw new Error("You must provide a Contentful client for the ContentfulClientList");this._clients[t]={client:n,previewClient:r||n}}getClient({source:t="default",isPreviewClient:n}){let r=this._clients[t];if(!!r)return n?r.previewClient:r.client}};var x={select:"fields",include:1},S=Object.freeze(["contentfulEntry"]);function Y(e){return e instanceof P}function D({client:e,previewClient:t,createQuery:n,useBatching:r,limitPolicy:d}){if(!e)throw new Error("No Contentful clients were provided to the enhancer. You must provide at least one client via the `client` or `clients` property.");let g=(()=>{if(Y(e))return e;let c=new P;return c.addClient({client:e,previewClient:t}),c})(),v=d||(0,h.createLimitPolicy)({throttle:{limit:55,interval:1e3}});return r?(0,h.createBatchEnhancer)({handleBatch:async c=>{var y;let i=c.reduce((o,l)=>{let{parameter:p,parameterName:m,component:w,context:a}=l.args,u=p.value;if(!O(u))return o;let f=V({parameterValue:u,parameterName:m,clients:g,component:w,context:a}),s="";if(E(u))s="legacy-group";else{let{source:I="default"}=u;s=I}return o[s]&&Array.isArray(o[s].tasks)?o[s].tasks.push(l):o[s]={client:f,tasks:[l]},o},{});try{console.time("fetch all entries");for await(let[o,l]of Object.entries(i)){let{context:p,component:m}=l.tasks[0].args,w=(y=n==null?void 0:n({component:m,defaultQuery:{...x},context:p}))!=null?y:x,a=new h.UniqueBatchEntries(l.tasks,f=>E(f.parameter.value)?f.parameter.value:f.parameter.value.entryId),u=Object.keys(a.groups);console.time(`fetch entries ${o}`);try{(await l.client.getEntries({"sys.id[in]":u.join(","),limit:u.length,...w})).items.forEach(s=>{a.resolveKey(s.sys.id,s)}),a.resolveRemaining(null)}finally{console.timeEnd(`fetch entries ${o}`)}}console.timeEnd("fetch all entries")}catch(o){let l=R(o),p=new Error(`Failed loading Contentful entries batch (${c.length}) ${l}`);c.forEach(m=>m.reject(p))}},shouldQueue:({parameter:c})=>T(c),limitPolicy:v}):{enhanceOne:async function({parameter:i,parameterName:y,component:o,context:l}){var p,m;if(T(i)){if(!O(i.value))return null;let w=V({clients:g,parameterName:y,parameterValue:i.value,component:o,context:l}),a=E(i.value)?i.value:i.value.entryId,u=(p=n==null?void 0:n({parameter:i,parameterName:y,component:o,defaultQuery:{...x},context:l}))!=null?p:x;try{return console.time(`fetch entry ${a}`),await w.getEntry(a,u)}catch(f){let s=R(f);throw E(i.value)?new Error(`Failed loading Contentful entry '${i.value}' referenced in parameter '${y}': ${s}`):new Error(`Failed loading Contentful entry '${a}' from source '${(m=i.value.source)!=null?m:"default"}' referenced in parameter '${y}': ${s}`)}finally{console.timeEnd(`fetch entry ${a}`)}}},limitPolicy:v}}function T(e){var t;return e.type===S[0]&&(((t=e.value)==null?void 0:t.entryId)||typeof e.value=="string")}function R(e){return typeof e=="string"?e:typeof e=="object"&&e&&"error"in e?e.error:e instanceof Error?e.toString():JSON.stringify(e,null,2)}function E(e){return typeof e=="string"}function O(e){return!(!e||!E(e)&&!e.entryId)}function V({clients:e,parameterValue:t,parameterName:n,component:r,context:d}){if(E(t)){let v=e.getClient({isPreviewClient:d.preview});if(!v)throw new Error(`Parameter '${n}' in component '${r.type}' has a value '${t}' that is not compatible with multi-space/environment usage. If you wish to use multiple spaces/environments, you must convert your Canvas component parameters to the multi-space/environment compatible version. Otherwise, you can continue to use your parameters as-is, but must specify one of the clients provided to the Contentful enhancer as the 'default' client by registering it without specifying a source key.`);return v}let{source:C="default"}=t,g=e.getClient({source:C,isPreviewClient:d.preview});if(!g)throw new Error(`No Contentful client could be resolved for source key '${C}' referenced in parameter '${n} in component '${r.type}'. Ensure that the 'clients' property you are passing to the enhancer has a client instance registered for the source key.`);return g}var k=L(require("@contentful/rich-text-html-renderer")),G=({parameter:e})=>{var t,n,r;return typeof((t=e.value)==null?void 0:t.fields)!="object"||Object.entries((r=(n=e.value)==null?void 0:n.fields)!=null?r:{}).forEach(([d,C])=>{typeof C=="object"&&"nodeType"in C&&C.nodeType==="document"&&(e.value.fields[d]=(0,k.documentToHtmlString)(C))}),e.value};0&&(module.exports={CANVAS_CONTENTFUL_PARAMETER_TYPES,ContentfulClientList,contentfulRichTextToHtmlEnhancer,createContentfulEnhancer});
